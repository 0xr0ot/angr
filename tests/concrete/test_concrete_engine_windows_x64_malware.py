#gdbserver 127.0.0.1:9999 /home/degrigis/Projects/Symbion/angr_tests/MalwareTest/dummy_malware

'''

 NO PACKER

'''

import angr
import avatar2 as avatar2
import claripy

from angr_targets import AvatarGDBConcreteTarget

MALWARE_PATH = "/home/degrigis/SharedVM/1238843.exe"
GDB_SERVER_IP = '192.168.56.101'
GDB_SERVER_PORT = 9999
STARTING_DECISION_ADDRESS = 0x401A30
DROPPING_MALWARE_MINER_ADDRESS = 0x401AE6
DROPPING_MALWARE_LOCKY_ADDRESS = 0x401AA6
MALWARE_EXECUTION_END = 0x401B7F
FAKE_CC = 0x401B2F
VENV_DETECTED = 0x401B17

avatar_gdb = AvatarGDBConcreteTarget(avatar2.archs.x86.X86_64, GDB_SERVER_IP ,GDB_SERVER_PORT)

p = angr.Project(MALWARE_PATH ,load_options={'auto_load_libs': False}, concrete_target=avatar_gdb)


print "[1]Executing malware concretely until address: " + hex(STARTING_DECISION_ADDRESS)

entry_state = p.factory.entry_state()


simgr = p.factory.simgr()
simgr.use_technique(angr.exploration_techniques.Symbion(find=[STARTING_DECISION_ADDRESS], concretize = []))
exploration = simgr.run()
new_concrete_state = exploration.stashes['found'][0]

arg0 = claripy.BVS('arg0',8*32)
symbolic_buffer_address = new_concrete_state.regs.rbp-0x60
new_concrete_state.memory.store(new_concrete_state.se.eval(symbolic_buffer_address),arg0)

print "[]Concrete_state pc: " + hex(new_concrete_state.se.eval(new_concrete_state.regs.pc))

simgr = p.factory.simgr(new_concrete_state)

print "[2]Symbolically executing malware to find dropping of second stage [ address:  " + hex(DROPPING_MALWARE_MINER_ADDRESS) + " ]"

exploration = simgr.explore(find=DROPPING_MALWARE_MINER_ADDRESS, avoid=[FAKE_CC,DROPPING_MALWARE_LOCKY_ADDRESS,VENV_DETECTED] )

new_symbolic_state = exploration.stashes['found'][0]

simgr = p.factory.simgr(new_symbolic_state)

print "[3]Executing malware concretely with solution found until the end " + hex(MALWARE_EXECUTION_END)

simgr.use_technique(angr.exploration_techniques.Symbion(find=[MALWARE_EXECUTION_END], concretize = [(symbolic_buffer_address,arg0)]))
exploration = simgr.run()

print "[4]Malware execution ends, the configuration value downloaded from C&C is: " + hex(new_symbolic_state.se.eval(arg0,cast_to=int))

avatar_gdb.exit()

print "\n\n\n\n"
